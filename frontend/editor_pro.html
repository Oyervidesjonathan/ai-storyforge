<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AI StoryForge ‚Äî Pro Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --bg1:#fff7ed; --bg2:#fef3c7; --ink:#222; --muted:#666;
      --card:#ffffff; --border:#eee; --shadow:0 10px 30px rgba(0,0,0,.08);
      --pill:#f3f4f6;
    }
    html,body{ height:100%; }
    body{
      font-family:Arial, sans-serif; margin:0; color:var(--ink);
      background: radial-gradient(1200px 600px at 20% -10%, var(--bg1), transparent 60%),
                  radial-gradient(1200px 600px at 120% 10%, var(--bg2), transparent 60%),
                  #faf6f2;
    }
    header{
      padding:14px 16px; background:rgba(255,255,255,.85);
      backdrop-filter: blur(6px); border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:3; display:flex; gap:12px; align-items:center;
    }
    h1{ font-size:18px; margin:0; }
    .badge{ background:var(--pill); padding:4px 8px; border-radius:999px; font-size:12px; color:#444; }
    main{ padding:16px; display:grid; grid-template-columns: 300px 1fr 420px; gap:16px; }
    @media (max-width:1200px){ main{ grid-template-columns: 1fr; } }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); }
    .card h3{ margin:0; padding:12px 14px; border-bottom:1px solid var(--border); font-size:15px; }
    .card .body{ padding:12px 14px; }

    select, textarea, input{ width:100%; font-size:14px; padding:10px; border:1px solid #ddd; border-radius:10px; box-sizing:border-box; }
    textarea{ min-height:240px; }
    button{ background:#222; color:#fff; border:none; border-radius:10px; padding:10px 14px; cursor:pointer; }
    button[disabled]{ opacity:.5; cursor:not-allowed; }
    .muted{ color:var(--muted); }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    /* Gallery + Big Preview */
    .gallery{ display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; }
    .thumb{ background:#fff; border:1px solid #ddd; border-radius:12px; padding:6px; cursor:pointer; }
    .thumb img{ width:100%; height:120px; object-fit:cover; border-radius:8px; display:block; }
    .thumb.sel{ outline:3px solid #666; }

    .preview{
      background:#fff; border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow);
      display:flex; align-items:center; justify-content:center; min-height:360px; padding:12px;
    }
    .preview img{ max-width:100%; max-height:620px; width:auto; height:auto; object-fit:contain; border-radius:12px; display:block; }

    /* Modal */
    dialog { border:none; border-radius:14px; padding:0; box-shadow:0 20px 50px rgba(0,0,0,.25); width:100%; max-width:560px; }
    dialog::backdrop{ background:rgba(0,0,0,.35); }
    .modal-h { padding:14px 16px; border-bottom:1px solid var(--border); font-weight:700; }
    .modal-b { padding:16px; display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .modal-b label{ font-size:.9em; color:#444; }
    .modal-b select { width:100%; padding:10px; }
    .modal-f { padding:14px 16px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:8px; }
    .btn-ghost{ background:#eee; color:#222; }
    .btn-ghost:hover{ background:#e3e3e3; }
  </style>
</head>
<body>
  <header>
    <h1>üìò Pro Editor</h1>
    <span id="hdrTitle" class="badge"></span>
    <span style="flex:1"></span>
    <a href="/ui"><button class="btn-ghost">‚Üê Back</button></a>
    <button id="btnFormat" title="Format for KDP">üß© Format</button>
  </header>

  <main>
    <!-- Book / chapter -->
    <section class="card">
      <h3>Book & Chapter</h3>
      <div class="body">
        <label class="muted">Book ID</label>
        <input id="bookId" readonly />
        <div style="height:10px"></div>
        <label>Chapter</label>
        <select id="chapSelect"></select>
      </div>
    </section>

    <!-- Text -->
    <section class="card">
      <h3>Chapter Text</h3>
      <div class="body">
        <label class="muted">Text (Markdown)</label>
        <textarea id="chapterText"></textarea>
        <div style="height:10px"></div>
        <button id="btnSaveText">üíæ Save Text</button>
        <span id="saveStatus" class="muted"></span>
      </div>
    </section>

    <!-- Images -->
    <section class="card">
      <h3>Images</h3>
      <div class="body">
        <div id="bigPreview" class="preview"><span class="muted">Select a thumbnail to preview</span></div>
        <div style="height:12px"></div>
        <div id="gallery" class="gallery"></div>
        <div style="height:10px"></div>
        <label>Image edit prompt</label>
        <textarea id="editPrompt" placeholder="e.g., make the dragon a bit smaller, add moonlight"></textarea>
        <div style="height:10px"></div>
        <button id="btnApplyEdit" disabled>Apply to selected</button>
        <span id="imgStatus" class="muted"></span>
      </div>
    </section>
  </main>

  <!-- KDP Options Modal -->
  <dialog id="formatModal">
    <div class="modal-h">Format for KDP</div>
    <div class="modal-b">
      <label>Trim size
        <select id="optTrim">
          <option value="8.5x8.5" selected>8.5" √ó 8.5" (square)</option>
          <option value="8x10">8" √ó 10"</option>
          <option value="7x10">7" √ó 10"</option>
        </select>
      </label>
      <label>Bleed
        <select id="optBleed">
          <option value="no" selected>No</option>
          <option value="yes">Yes (0.125")</option>
        </select>
      </label>
      <label>Font
        <select id="optFont">
          <option value="Literata" selected>Literata</option>
          <option value="Georgia">Georgia</option>
          <option value="Atkinson Hyperlegible">Atkinson Hyperlegible</option>
        </select>
      </label>
      <label>Line height
        <select id="optLH">
          <option value="1.4">1.4</option>
          <option value="1.6" selected>1.6</option>
          <option value="1.8">1.8</option>
        </select>
      </label>
      <label style="grid-column:1 / -1;">Background style
        <select id="optBG">
          <option value="blur" selected>Plain (clean)</option>
          <option value="tint">Tinted text box</option>
        </select>
      </label>
      <p class="muted" style="grid-column:1 / -1;margin:4px 0 0 0;">Tip: Keep text 0.375" from the trim line.</p>
    </div>
    <div class="modal-f">
      <button id="btnFmtCancel" c
